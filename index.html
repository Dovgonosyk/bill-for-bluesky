<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <!-- Primary Meta Tags -->
  <title>Bill for Bluesky | Donate to Come Back Alive ðŸ‡ºðŸ‡¦</title>
  <meta name="title" content="Bill for Bluesky | Donate to Come Back Alive ðŸ‡ºðŸ‡¦">
  <meta name="description" content="Calculate your Bluesky social media activity bill based on posts, reposts, and replies. Turn your engagement into a donation for Ukraine's defenders through Come Back Alive foundation.">
  <meta name="keywords" content="Bluesky, bill calculator, donate Ukraine, Come Back Alive, ÐŸÐ¾Ð²ÐµÑ€Ð½Ð¸ÑÑŒ Ð–Ð¸Ð²Ð¸Ð¼, social media, charity, support Ukraine, Bluesky activity">
  <meta name="author" content="Bill for Bluesky">
  <meta name="robots" content="index, follow">
  <meta name="language" content="English, Ukrainian, Japanese, German, French, Spanish, Portuguese, Polish">
  
  <!-- Theme Color -->
  <meta name="theme-color" content="#1185fe">
  <meta name="msapplication-TileColor" content="#1185fe">
  
  <!-- Open Graph / Facebook -->
  <meta property="og:type" content="website">
  <meta property="og:url" content="https://dovgonosyk.github.io/bill-for-bluesky">
  <meta property="og:title" content="Bill for Bluesky | Donate to Come Back Alive ðŸ‡ºðŸ‡¦">
  <meta property="og:description" content="Calculate your Bluesky activity bill and turn your social media engagement into support for Ukraine's defenders.">
  <meta property="og:image" content="https://dovgonosyk.github.io/bill-for-bluesky/og-image.png">
  <meta property="og:locale" content="en_US">
  <meta property="og:locale:alternate" content="uk_UA">
  <meta property="og:site_name" content="Bill for Bluesky">
  
  <!-- Twitter -->
  <meta property="twitter:card" content="summary_large_image">
  <meta property="twitter:url" content="https://dovgonosyk.github.io/bill-for-bluesky/">
  <meta property="twitter:title" content="Bill for Bluesky | Donate to Come Back Alive ðŸ‡ºðŸ‡¦">
  <meta property="twitter:description" content="Calculate your Bluesky activity bill and turn your social media engagement into support for Ukraine's defenders.">
  <meta property="twitter:image" content="https://dovgonosyk.github.io/bill-for-bluesky/og-image.png">
  
  <!-- Canonical URL -->
  <link rel="canonical" href="https://dovgonosyk.github.io/bill-for-bluesky/">
  
  <!-- Alternate languages -->
  <link rel="alternate" hreflang="en" href="https://dovgonosyk.github.io/bill-for-bluesky/?lang=en">
  <link rel="alternate" hreflang="uk" href="https://dovgonosyk.github.io/bill-for-bluesky/?lang=uk">
  <link rel="alternate" hreflang="ja" href="https://dovgonosyk.github.io/bill-for-bluesky/?lang=ja">
  <link rel="alternate" hreflang="de" href="https://dovgonosyk.github.io/bill-for-bluesky/?lang=de">
  <link rel="alternate" hreflang="fr" href="https://dovgonosyk.github.io/bill-for-bluesky/?lang=fr">
  <link rel="alternate" hreflang="es" href="https://dovgonosyk.github.io/bill-for-bluesky/?lang=es">
  <link rel="alternate" hreflang="pt" href="https://dovgonosyk.github.io/bill-for-bluesky/?lang=pt">
  <link rel="alternate" hreflang="pl" href="https://dovgonosyk.github.io/bill-for-bluesky/?lang=pl">
  <link rel="alternate" hreflang="x-default" href="https://dovgonosyk.github.io/bill-for-bluesky/">
  
  <!-- Preconnect to external resources -->
  <link rel="preconnect" href="https://public.api.bsky.app">
  <link rel="dns-prefetch" href="https://public.api.bsky.app">
  <link rel="preconnect" href="https://cdn.bsky.app">
  <link rel="dns-prefetch" href="https://cdn.bsky.app">
  
  <!-- Favicon -->
  <link rel="icon" type="image/png" sizes="32x32" href="favicon-32.png">
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ðŸ¦‹</text></svg>">
  <link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png">
  
  <!-- Structured Data -->
  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "WebApplication",
    "name": "Bill for Bluesky",
    "description": "Calculate your Bluesky social media activity bill and donate to support Ukraine's defenders through Come Back Alive foundation.",
    "url": "https://example.com/",
    "applicationCategory": "SocialNetworkingApplication",
    "operatingSystem": "Any",
    "offers": {
      "@type": "Offer",
      "price": "0",
      "priceCurrency": "UAH"
    },
    "author": {
      "@type": "Organization",
      "name": "Bill for Bluesky"
    },
    "potentialAction": {
      "@type": "UseAction",
      "target": "https://example.com/?handle={handle}",
      "query-input": "required name=handle"
    }
  }
  </script>
  
  <style>
    :root {
      --blue: #1185fe;
      --blue-dark: #0969da;
      --yellow: #ffd700;
      --ua-blue: #0057b7;
      --ua-yellow: #ffd700;
      --bg: #f8fafc;
      --card-bg: #ffffff;
      --text: #1e293b;
      --text-muted: #64748b;
      --border: #e2e8f0;
      --success: #22c55e;
      --error: #ef4444;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      line-height: 1.5;
      -webkit-text-size-adjust: 100%;
    }

    .container {
      max-width: 480px;
      margin: 0 auto;
      padding: 1rem;
      position: relative;
    }

    header {
      text-align: center;
      padding: 2rem 0;
    }

    .logo {
      font-size: 3rem;
      margin-bottom: 0.5rem;
    }

    h1 {
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--text);
      margin-bottom: 0.25rem;
    }

    .subtitle {
      color: var(--text-muted);
      font-size: 0.9rem;
    }

    .input-section {
      background: var(--card-bg);
      border-radius: 12px;
      padding: 1.5rem;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      margin-bottom: 1rem;
    }

    .input-group {
      display: flex;
      gap: 0.5rem;
      margin-bottom: 1rem;
    }

    input[type="text"] {
      flex: 1;
      min-width: 0;
      padding: 0.875rem 1rem;
      border: 2px solid var(--border);
      border-radius: 8px;
      font-size: 1rem;
      transition: border-color 0.2s;
      -webkit-appearance: none;
      appearance: none;
    }

    input[type="text"]:focus {
      outline: none;
      border-color: var(--blue);
    }

    .btn {
      padding: 0.875rem 1.5rem;
      border: none;
      border-radius: 8px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      -webkit-appearance: none;
      appearance: none;
      -webkit-tap-highlight-color: transparent;
      touch-action: manipulation;
    }

    .btn-primary {
      background: var(--blue);
      color: white;
      white-space: nowrap;
      flex-shrink: 0;
    }

    .btn-primary:hover {
      background: var(--blue-dark);
    }

    .btn-primary:active {
      transform: scale(0.97);
    }

    .btn-primary:disabled {
      background: var(--text-muted);
      cursor: not-allowed;
    }

    .period-selector {
      display: flex;
      gap: 0.5rem;
    }

    .period-btn {
      flex: 1;
      min-width: 0;
      padding: 0.625rem 0.25rem;
      background: var(--bg);
      border: 2px solid var(--border);
      border-radius: 6px;
      font-size: 0.875rem;
      cursor: pointer;
      transition: all 0.2s;
      -webkit-appearance: none;
      appearance: none;
      -webkit-tap-highlight-color: transparent;
      touch-action: manipulation;
      text-align: center;
      white-space: nowrap;
    }

    .period-btn:hover {
      border-color: var(--blue);
    }

    .period-btn:active {
      transform: scale(0.97);
    }

    .period-btn.active {
      background: var(--blue);
      color: white;
      border-color: var(--blue);
    }

    .loading {
      text-align: center;
      padding: 2rem;
      display: none;
    }

    .loading.show {
      display: block;
    }

    .spinner {
      width: 40px;
      height: 40px;
      border: 3px solid var(--border);
      border-top-color: var(--blue);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 1rem;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .error {
      background: #fef2f2;
      border: 1px solid var(--error);
      color: var(--error);
      padding: 1rem;
      border-radius: 8px;
      margin-bottom: 1rem;
      display: none;
    }

    .error.show {
      display: block;
    }

    .results {
      display: none;
    }

    .results.show {
      display: block;
    }

    .bill {
      background: var(--card-bg);
      border: 3px solid var(--blue);
      border-radius: 12px;
      overflow: hidden;
      margin-bottom: 1rem;
    }

    .bill-header {
      background: var(--blue);
      color: white;
      padding: 1rem;
      text-align: center;
    }

    .bill-header h2 {
      font-size: 1.25rem;
      margin-bottom: 0.25rem;
    }

    .bill-period {
      font-size: 0.875rem;
      opacity: 0.9;
    }

    .bill-body {
      padding: 1.5rem;
      font-family: 'Courier New', monospace;
    }

    .employee-info {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      margin-bottom: 1rem;
      padding-bottom: 1rem;
      border-bottom: 2px dashed var(--border);
    }

    .avatar {
      width: 48px;
      height: 48px;
      border-radius: 50%;
      background: var(--blue);
      flex-shrink: 0;
    }

    .avatar[src=""], .avatar:not([src]) {
      display: none;
    }

    .employee-name {
      font-weight: 700;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .employee-handle {
      color: var(--text-muted);
      font-size: 0.875rem;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .line-item {
      display: flex;
      justify-content: space-between;
      padding: 0.375rem 0;
      font-size: 0.875rem;
    }

    .line-item-label {
      color: var(--text-muted);
    }

    .line-item-count {
      color: var(--text);
    }

    .line-item-amount {
      font-weight: 600;
      min-width: 80px;
      text-align: right;
      flex-shrink: 0;
    }

    .divider {
      border-top: 2px dashed var(--border);
      margin: 0.75rem 0;
    }

    .total-line {
      display: flex;
      justify-content: space-between;
      font-size: 1.125rem;
      font-weight: 700;
      padding-top: 0.5rem;
    }

    .total-amount {
      color: var(--success);
    }

    .cta-section {
      background: linear-gradient(135deg, var(--ua-blue) 0%, #1e40af 100%);
      border-radius: 12px;
      padding: 1.5rem;
      text-align: center;
      color: white;
      margin-bottom: 1rem;
    }

    .cta-section h3 {
      font-size: 1.125rem;
      margin-bottom: 0.5rem;
    }

    .cta-section p {
      font-size: 0.875rem;
      opacity: 0.9;
      margin-bottom: 1rem;
    }

    .btn-donate {
      background: var(--ua-yellow);
      color: var(--ua-blue);
      width: 100%;
      font-size: 1.125rem;
      padding: 1rem;
    }

    .btn-donate:hover {
      background: #e6c200;
    }

    .btn-donate:active {
      transform: scale(0.98);
    }

    .btn-share {
      background: var(--card-bg);
      color: var(--blue);
      border: 2px solid var(--blue);
      width: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
    }

    .btn-share:hover {
      background: var(--blue);
      color: white;
    }

    .btn-share:active {
      transform: scale(0.98);
    }

    .share-section {
      background: var(--card-bg);
      border-radius: 12px;
      padding: 1.5rem;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }

    footer {
      text-align: center;
      padding: 2rem 0;
      color: var(--text-muted);
      font-size: 0.8rem;
    }

    footer a {
      color: var(--blue);
      text-decoration: none;
    }

    .rates-info {
      font-size: 0.75rem;
      color: var(--text-muted);
      margin-top: 1rem;
      padding: 0.75rem;
      background: var(--bg);
      border-radius: 6px 6px 0 0;
    }

    .empty-state {
      text-align: center;
      color: var(--text-muted);
      padding: 1rem;
      font-style: italic;
    }

    .checkbox-label {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.75rem;
      background: var(--bg);
      border-radius: 0 0 6px 6px;
      border-top: 1px dashed var(--border);
      cursor: pointer;
      font-size: 0.9rem;
      transition: background 0.2s;
    }

    .checkbox-label:hover {
      background: #e2e8f0;
    }

    .checkbox-label input[type="checkbox"] {
      width: 18px;
      height: 18px;
      cursor: pointer;
      accent-color: var(--blue);
      flex-shrink: 0;
    }

    .multiplier-badge {
      background: var(--blue);
      color: white;
      font-size: 0.7rem;
      font-weight: 700;
      padding: 0.2rem 0.4rem;
      border-radius: 4px;
      margin-left: auto;
      flex-shrink: 0;
    }

    /* Language toggle */
    .lang-toggle {
      position: absolute;
      top: 1rem;
      right: 1rem;
      display: flex;
      flex-wrap: wrap;
      justify-content: flex-end;
      gap: 0.2rem;
      max-width: 220px;
    }

    .lang-btn {
      padding: 0.3rem 0.4rem;
      background: transparent;
      border: 1px solid var(--border);
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.65rem;
      font-weight: 600;
      -webkit-tap-highlight-color: transparent;
      touch-action: manipulation;
    }

    .lang-btn.active {
      background: var(--blue);
      color: white;
      border-color: var(--blue);
    }

    /* Skip link for accessibility */
    .skip-link {
      position: absolute;
      top: -100px;
      left: 0;
      background: var(--blue);
      color: white;
      padding: 0.5rem 1rem;
      z-index: 1000;
      text-decoration: none;
      border-radius: 0 0 4px 0;
    }

    .skip-link:focus {
      top: 0;
    }

    /* ==========================================
       Mobile-specific fixes
       ========================================== */
    @media (max-width: 400px) {
      .container {
        padding: 0.75rem;
      }

      header {
        padding: 1.5rem 0 1rem;
      }

      .logo {
        font-size: 2.5rem;
      }

      h1 {
        font-size: 1.25rem;
      }

      .input-section {
        padding: 1rem;
      }

      .input-group {
        flex-direction: column;
      }

      .btn-primary {
        width: 100%;
        text-align: center;
      }

      .period-btn {
        font-size: 0.8rem;
        padding: 0.5rem 0.125rem;
      }

      .bill-body {
        padding: 1rem;
      }

      .cta-section {
        padding: 1.25rem;
      }

      .btn-donate {
        font-size: 1rem;
        padding: 0.875rem;
      }

      .share-section {
        padding: 1rem;
      }
    }

    @media (max-width: 320px) {
      .period-selector {
        flex-wrap: wrap;
      }

      .period-btn {
        flex: 1 1 calc(33% - 0.35rem);
      }
    }

    /* Fix iOS button rendering */
    @supports (-webkit-touch-callout: none) {
      .btn,
      .period-btn,
      .lang-btn,
      .btn-donate,
      .btn-share {
        -webkit-appearance: none;
        appearance: none;
      }

      input[type="text"] {
        font-size: 16px; /* prevents iOS zoom on focus */
      }
    }
  </style>
</head>
<body>
  <noscript>
    <div style="padding: 2rem; text-align: center; background: #fef2f2; color: #ef4444;">
      <p><strong>JavaScript is required</strong></p>
      <p>This app needs JavaScript to calculate your Bluesky bill. Please enable JavaScript in your browser.</p>
    </div>
  </noscript>
  <a href="#handle-input" class="skip-link">Skip to main content</a>
  <div class="container">
    <div class="lang-toggle">
      <button class="lang-btn" data-lang="en">EN</button>
      <button class="lang-btn" data-lang="uk">UA</button>
      <button class="lang-btn" data-lang="pl">PL</button>
      <button class="lang-btn" data-lang="de">DE</button>
      <button class="lang-btn" data-lang="fr">FR</button>
      <button class="lang-btn" data-lang="es">ES</button>
      <button class="lang-btn" data-lang="pt">PT</button>
      <button class="lang-btn" data-lang="ja">JA</button>
    </div>

    <header>
      <div class="logo">ðŸ¦‹</div>
      <h1 data-i18n="title">Bill for Bluesky</h1>
      <p class="subtitle" data-i18n="subtitle">Turn your social activity into support for Ukraine</p>
    </header>

    <main class="input-section" role="search">
      <div class="input-group">
        <input 
          type="text" 
          id="handle-input" 
          placeholder="handle.bsky.social"
          autocomplete="off"
          autocapitalize="none"
          aria-label="Bluesky handle"
        >
        <button class="btn btn-primary" id="calculate-btn" data-i18n="calculate">Calculate</button>
      </div>

      <nav class="period-selector" aria-label="Time period selection">
        <button class="period-btn" data-period="day" data-i18n="today" aria-pressed="false">Today</button>
        <button class="period-btn active" data-period="week" data-i18n="week" aria-pressed="true">Week</button>
        <button class="period-btn" data-period="month" data-i18n="month" aria-pressed="false">Month</button>
      </nav>

      <div class="rates-info">
        <strong data-i18n="ratesTitle">Rates:</strong> 
        <span data-i18n="ratesDescription">Post: 5â‚´ | Repost: 3â‚´ | Reply: 2â‚´</span>
      </div>

      <label class="checkbox-label">
        <input type="checkbox" id="it-checkbox" aria-describedby="multiplier-info">
        <span data-i18n="itCheckbox">Are you in IT?</span>
        <span class="multiplier-badge" id="multiplier-info" aria-label="10 times multiplier">Ã—10</span>
      </label>
    </main>

    <div class="error" id="error-message" role="alert" aria-live="polite"></div>

    <div class="loading" id="loading" aria-live="polite">
      <div class="spinner" aria-hidden="true"></div>
      <p data-i18n="loading">Fetching your activity...</p>
    </div>

    <section class="results" id="results" aria-label="Bill results">
      <article class="bill">
        <div class="bill-header">
          <h2 data-i18n="bill">ðŸ§¾ YOUR BILL</h2>
          <div class="bill-period" id="period-display"></div>
        </div>
        <div class="bill-body">
          <div class="employee-info">
            <img class="avatar" id="avatar" src="" alt="Profile avatar">
            <div style="min-width: 0;">
              <div class="employee-name" id="display-name"></div>
              <div class="employee-handle" id="handle-display"></div>
            </div>
          </div>

          <div id="breakdown"></div>

          <div class="divider"></div>

          <div class="total-line">
            <span data-i18n="total">TOTAL:</span>
            <span class="total-amount" id="total-amount"></span>
          </div>
        </div>
      </article>

      <aside class="cta-section" aria-label="Donation call to action">
        <h3>ðŸ‡ºðŸ‡¦ <span data-i18n="ctaTitle">Support Ukraine's Defenders</span></h3>
        <p data-i18n="ctaDescription">Consider donating your bill amount to Come Back Alive foundation</p>
        <button class="btn btn-donate" id="donate-btn" aria-label="Donate to Come Back Alive foundation">
          ðŸ’™ðŸ’› <span data-i18n="donate">Donate to Come Back Alive</span>
        </button>
      </aside>

      <div class="share-section">
        <button class="btn btn-share" id="share-btn" aria-label="Share your bill on Bluesky">
          <svg width="20" height="20" viewBox="0 0 600 530" fill="currentColor" aria-hidden="true">
            <path d="m135.72 44.03c66.496 49.921 138.02 151.14 164.28 205.46 26.262-54.316 97.782-155.54 164.28-205.46 47.98-36.021 125.72-63.892 125.72 24.795 0 17.712-10.155 148.79-16.111 170.07-20.703 73.984-96.144 92.854-163.25 81.433 117.3 19.964 147.14 86.092 82.697 152.22-122.39 125.59-175.91-31.511-189.63-71.766-2.514-7.3797-3.6904-10.832-3.7077-7.8964-0.0174-2.9357-1.1937 0.51669-3.7077 7.8964-13.714 40.255-67.233 197.36-189.63 71.766-64.444-66.128-34.605-132.26 82.697-152.22-67.108 11.421-142.55-7.4491-163.25-81.433-5.9562-21.282-16.111-152.36-16.111-170.07 0-88.687 77.742-60.816 125.72-24.795z"/>
          </svg>
          <span data-i18n="share">Share on Bluesky</span>
        </button>
      </div>
    </section>

    <footer>
      <p>
        <span data-i18n="madeWith">Made with ðŸ’™ðŸ’› for Ukraine</span> | 
        <a href="https://savelife.in.ua/en/" target="_blank" rel="noopener noreferrer">Come Back Alive</a>
      </p>
      <p style="margin-top: 0.5rem;">
        <span data-i18n="apiNote">Using public Bluesky API â€¢ No authentication required</span>
      </p>
    </footer>
  </div>

  <script>
    // ============================================
    // Configuration
    // ============================================
    const CONFIG = {
      API_BASE: 'https://public.api.bsky.app/xrpc',
      DONATE_URL: 'https://savelife.in.ua/en/donate-en/',
      RATES: {
        post: 5,
        repost: 3,
        reply: 2
      },
      VALID_PERIODS: ['day', 'week', 'month']
    };

    // ============================================
    // Internationalization
    // ============================================
    const i18n = {
      en: {
        title: 'Bill for Bluesky',
        subtitle: 'Turn your social activity into support for Ukraine',
        calculate: 'Calculate',
        today: 'Today',
        week: 'Week',
        month: 'Month',
        ratesTitle: 'Rates:',
        ratesDescription: 'Post: 5â‚´ | Repost: 3â‚´ | Reply: 2â‚´',
        itCheckbox: 'Are you in IT?',
        loading: 'Fetching your activity...',
        bill: 'ðŸ§¾ YOUR BILL',
        posts: 'Posts created',
        reposts: 'Reposts made',
        replies: 'Replies made',
        total: 'TOTAL:',
        ctaTitle: "Support Ukraine's Defenders",
        ctaDescription: 'Consider donating your bill amount to Come Back Alive foundation',
        donate: 'Donate to Come Back Alive',
        share: 'Share on Bluesky',
        madeWith: 'Made with ðŸ’™ðŸ’› for Ukraine',
        apiNote: 'Using public Bluesky API â€¢ No authentication required',
        errorNotFound: 'Profile not found. Please check the handle.',
        errorApi: 'Failed to fetch data. Please try again.',
        errorEmpty: 'Please enter a Bluesky handle.',
        errorInvalidHandle: 'Invalid handle format. Use: handle.bsky.social',
        emptyState: 'No activity found for this period. Try a longer time range!',
        shareText: 'ðŸ¦‹ My Bill for Bluesky: {amount} UAH!\n\nCheck yours & donate to Come Back Alive ðŸ‡ºðŸ‡¦\n\n'
      },
      uk: {
        title: 'Ð Ð°Ñ…ÑƒÐ½Ð¾Ðº Ð·Ð° Bluesky',
        subtitle: 'ÐŸÐµÑ€ÐµÑ‚Ð²Ð¾Ñ€Ñ–Ñ‚ÑŒ Ð²Ð°ÑˆÑƒ Ð°ÐºÑ‚Ð¸Ð²Ð½Ñ–ÑÑ‚ÑŒ Ð½Ð° Ð¿Ñ–Ð´Ñ‚Ñ€Ð¸Ð¼ÐºÑƒ Ð£ÐºÑ€Ð°Ñ—Ð½Ð¸',
        calculate: 'Ð Ð¾Ð·Ñ€Ð°Ñ…ÑƒÐ²Ð°Ñ‚Ð¸',
        today: 'Ð¡ÑŒÐ¾Ð³Ð¾Ð´Ð½Ñ–',
        week: 'Ð¢Ð¸Ð¶Ð´ÐµÐ½ÑŒ',
        month: 'ÐœÑ–ÑÑÑ†ÑŒ',
        ratesTitle: 'Ð¢Ð°Ñ€Ð¸Ñ„Ð¸:',
        ratesDescription: 'ÐŸÐ¾ÑÑ‚: 5â‚´ | Ð ÐµÐ¿Ð¾ÑÑ‚: 3â‚´ | Ð’Ñ–Ð´Ð¿Ð¾Ð²Ñ–Ð´ÑŒ: 2â‚´',
        itCheckbox: 'Ð’Ð¸ Ð°Ð¹Ñ‚Ñ–ÑˆÐ½Ð¸Ðº?',
        loading: 'Ð—Ð°Ð²Ð°Ð½Ñ‚Ð°Ð¶ÐµÐ½Ð½Ñ Ð°ÐºÑ‚Ð¸Ð²Ð½Ð¾ÑÑ‚Ñ–...',
        bill: 'ðŸ§¾ Ð’ÐÐ¨ Ð ÐÐ¥Ð£ÐÐžÐš',
        posts: 'ÐŸÐ¾ÑÑ‚Ñ–Ð² ÑÑ‚Ð²Ð¾Ñ€ÐµÐ½Ð¾',
        reposts: 'Ð ÐµÐ¿Ð¾ÑÑ‚Ñ–Ð² Ð·Ñ€Ð¾Ð±Ð»ÐµÐ½Ð¾',
        replies: 'Ð’Ñ–Ð´Ð¿Ð¾Ð²Ñ–Ð´ÐµÐ¹',
        total: 'Ð’Ð¡Ð¬ÐžÐ“Ðž:',
        ctaTitle: 'ÐŸÑ–Ð´Ñ‚Ñ€Ð¸Ð¼Ð°Ð¹Ñ‚Ðµ Ð·Ð°Ñ…Ð¸ÑÐ½Ð¸ÐºÑ–Ð² Ð£ÐºÑ€Ð°Ñ—Ð½Ð¸',
        ctaDescription: 'Ð—Ð°Ð´Ð¾Ð½Ð°Ñ‚ÑŒÑ‚Ðµ ÑÑƒÐ¼Ñƒ Ð²Ð°ÑˆÐ¾Ð³Ð¾ Ñ€Ð°Ñ…ÑƒÐ½ÐºÑƒ Ð½Ð° Ñ„Ð¾Ð½Ð´ ÐŸÐ¾Ð²ÐµÑ€Ð½Ð¸ÑÑŒ Ð–Ð¸Ð²Ð¸Ð¼',
        donate: 'Ð—Ð°Ð´Ð¾Ð½Ð°Ñ‚Ð¸Ñ‚Ð¸ Ð½Ð° ÐŸÐ¾Ð²ÐµÑ€Ð½Ð¸ÑÑŒ Ð–Ð¸Ð²Ð¸Ð¼',
        share: 'ÐŸÐ¾Ð´Ñ–Ð»Ð¸Ñ‚Ð¸ÑÑ Ð² Bluesky',
        madeWith: 'Ð—Ñ€Ð¾Ð±Ð»ÐµÐ½Ð¾ Ð· ðŸ’™ðŸ’› Ð´Ð»Ñ Ð£ÐºÑ€Ð°Ñ—Ð½Ð¸',
        apiNote: 'Ð’Ð¸ÐºÐ¾Ñ€Ð¸ÑÑ‚Ð¾Ð²ÑƒÑ” Ð¿ÑƒÐ±Ð»Ñ–Ñ‡Ð½Ð¸Ð¹ API Bluesky â€¢ Ð‘ÐµÐ· Ð°Ð²Ñ‚Ð¾Ñ€Ð¸Ð·Ð°Ñ†Ñ–Ñ—',
        errorNotFound: 'ÐŸÑ€Ð¾Ñ„Ñ–Ð»ÑŒ Ð½Ðµ Ð·Ð½Ð°Ð¹Ð´ÐµÐ½Ð¾. ÐŸÐµÑ€ÐµÐ²Ñ–Ñ€Ñ‚Ðµ handle.',
        errorApi: 'ÐŸÐ¾Ð¼Ð¸Ð»ÐºÐ° Ð·Ð°Ð²Ð°Ð½Ñ‚Ð°Ð¶ÐµÐ½Ð½Ñ. Ð¡Ð¿Ñ€Ð¾Ð±ÑƒÐ¹Ñ‚Ðµ Ñ‰Ðµ Ñ€Ð°Ð·.',
        errorEmpty: 'Ð‘ÑƒÐ´ÑŒ Ð»Ð°ÑÐºÐ°, Ð²Ð²ÐµÐ´Ñ–Ñ‚ÑŒ Bluesky handle.',
        errorInvalidHandle: 'ÐÐµÐ²Ñ–Ñ€Ð½Ð¸Ð¹ Ñ„Ð¾Ñ€Ð¼Ð°Ñ‚. Ð’Ð¸ÐºÐ¾Ñ€Ð¸ÑÑ‚Ð¾Ð²ÑƒÐ¹Ñ‚Ðµ: handle.bsky.social',
        emptyState: 'ÐÐµÐ¼Ð°Ñ” Ð°ÐºÑ‚Ð¸Ð²Ð½Ð¾ÑÑ‚Ñ– Ð·Ð° Ñ†ÐµÐ¹ Ð¿ÐµÑ€Ñ–Ð¾Ð´. Ð¡Ð¿Ñ€Ð¾Ð±ÑƒÐ¹Ñ‚Ðµ Ð±Ñ–Ð»ÑŒÑˆÐ¸Ð¹ Ð¿Ñ€Ð¾Ð¼Ñ–Ð¶Ð¾Ðº Ñ‡Ð°ÑÑƒ!',
        shareText: 'ðŸ¦‹ ÐœÑ–Ð¹ Ñ€Ð°Ñ…ÑƒÐ½Ð¾Ðº Ð·Ð° Bluesky: {amount} Ð³Ñ€Ð½!\n\nÐŸÐµÑ€ÐµÐ²Ñ–Ñ€ ÑÐ²Ñ–Ð¹ Ñ‚Ð° Ð·Ð°Ð´Ð¾Ð½Ð°Ñ‚ÑŒ Ð½Ð° ÐŸÐ¾Ð²ÐµÑ€Ð½Ð¸ÑÑŒ Ð–Ð¸Ð²Ð¸Ð¼ ðŸ‡ºðŸ‡¦\n\n'
      },

      ja: {
        title: 'Blueskyã®è«‹æ±‚æ›¸',
        subtitle: 'ã‚ãªãŸã®SNSæ´»å‹•ã‚’ã‚¦ã‚¯ãƒ©ã‚¤ãƒŠæ”¯æ´ã«',
        calculate: 'è¨ˆç®—ã™ã‚‹',
        today: 'ä»Šæ—¥',
        week: 'é€±é–“',
        month: 'æœˆé–“',
        ratesTitle: 'æ–™é‡‘:',
        ratesDescription: 'æŠ•ç¨¿: 5â‚´ | ãƒªãƒã‚¹ãƒˆ: 3â‚´ | è¿”ä¿¡: 2â‚´',
        itCheckbox: 'ITæ¥­ç•Œã§ã™ã‹ï¼Ÿ',
        loading: 'ã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£ã‚’å–å¾—ä¸­...',
        bill: 'ðŸ§¾ ã‚ãªãŸã®è«‹æ±‚æ›¸',
        posts: 'æŠ•ç¨¿æ•°',
        reposts: 'ãƒªãƒã‚¹ãƒˆæ•°',
        replies: 'è¿”ä¿¡æ•°',
        total: 'åˆè¨ˆ:',
        ctaTitle: 'ã‚¦ã‚¯ãƒ©ã‚¤ãƒŠã®é˜²è¡›è€…ã‚’æ”¯æ´',
        ctaDescription: 'è«‹æ±‚é¡ã‚’Come Back AliveåŸºé‡‘ã«å¯„ä»˜ã—ã¾ã›ã‚“ã‹',
        donate: 'Come Back Aliveã«å¯„ä»˜',
        share: 'Blueskyã§ã‚·ã‚§ã‚¢',
        madeWith: 'ðŸ’™ðŸ’› ã‚¦ã‚¯ãƒ©ã‚¤ãƒŠã®ãŸã‚ã«',
        apiNote: 'Blueskyå…¬é–‹APIã‚’ä½¿ç”¨ â€¢ èªè¨¼ä¸è¦',
        errorNotFound: 'ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚ãƒãƒ³ãƒ‰ãƒ«ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚',
        errorApi: 'ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚',
        errorEmpty: 'Blueskyãƒãƒ³ãƒ‰ãƒ«ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚',
        errorInvalidHandle: 'ç„¡åŠ¹ãªå½¢å¼ã§ã™ã€‚ä¾‹: handle.bsky.social',
        emptyState: 'ã“ã®æœŸé–“ã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£ãŒã‚ã‚Šã¾ã›ã‚“ã€‚ã‚‚ã£ã¨é•·ã„æœŸé–“ã‚’è©¦ã—ã¦ãã ã•ã„ï¼',
        shareText: 'ðŸ¦‹ ç§ã®Blueskyè«‹æ±‚æ›¸: {amount} UAH!\n\nã‚ãªãŸã‚‚ãƒã‚§ãƒƒã‚¯ã—ã¦Come Back Aliveã«å¯„ä»˜ã—ã‚ˆã† ðŸ‡ºðŸ‡¦\n\n'
      },
      de: {
        title: 'Rechnung fÃ¼r Bluesky',
        subtitle: 'Verwandle deine AktivitÃ¤t in UnterstÃ¼tzung fÃ¼r die Ukraine',
        calculate: 'Berechnen',
        today: 'Heute',
        week: 'Woche',
        month: 'Monat',
        ratesTitle: 'Tarife:',
        ratesDescription: 'Post: 5â‚´ | Repost: 3â‚´ | Antwort: 2â‚´',
        itCheckbox: 'Bist du in der IT?',
        loading: 'AktivitÃ¤t wird geladen...',
        bill: 'ðŸ§¾ DEINE RECHNUNG',
        posts: 'BeitrÃ¤ge erstellt',
        reposts: 'Reposts gemacht',
        replies: 'Antworten geschrieben',
        total: 'GESAMT:',
        ctaTitle: 'UnterstÃ¼tze die Verteidiger der Ukraine',
        ctaDescription: 'Spende den Rechnungsbetrag an die Come Back Alive Stiftung',
        donate: 'An Come Back Alive spenden',
        share: 'Auf Bluesky teilen',
        madeWith: 'Mit ðŸ’™ðŸ’› fÃ¼r die Ukraine',
        apiNote: 'Nutzt die Ã¶ffentliche Bluesky API â€¢ Keine Anmeldung nÃ¶tig',
        errorNotFound: 'Profil nicht gefunden. Bitte Ã¼berprÃ¼fe den Handle.',
        errorApi: 'Daten konnten nicht geladen werden. Bitte versuche es erneut.',
        errorEmpty: 'Bitte gib einen Bluesky Handle ein.',
        errorInvalidHandle: 'UngÃ¼ltiges Format. Nutze: handle.bsky.social',
        emptyState: 'Keine AktivitÃ¤t in diesem Zeitraum. Versuche einen lÃ¤ngeren Zeitraum!',
        shareText: 'ðŸ¦‹ Meine Rechnung fÃ¼r Bluesky: {amount} UAH!\n\nPrÃ¼fe deine & spende an Come Back Alive ðŸ‡ºðŸ‡¦\n\n'
      },
      fr: {
        title: 'Facture Bluesky',
        subtitle: 'Transformez votre activitÃ© en soutien pour l\'Ukraine',
        calculate: 'Calculer',
        today: 'Aujourd\'hui',
        week: 'Semaine',
        month: 'Mois',
        ratesTitle: 'Tarifs :',
        ratesDescription: 'Post : 5â‚´ | Repost : 3â‚´ | RÃ©ponse : 2â‚´',
        itCheckbox: 'Vous Ãªtes dans l\'IT ?',
        loading: 'Chargement de votre activitÃ©...',
        bill: 'ðŸ§¾ VOTRE FACTURE',
        posts: 'Posts crÃ©Ã©s',
        reposts: 'Reposts effectuÃ©s',
        replies: 'RÃ©ponses Ã©crites',
        total: 'TOTAL :',
        ctaTitle: 'Soutenez les dÃ©fenseurs de l\'Ukraine',
        ctaDescription: 'Faites un don du montant de votre facture Ã  la fondation Come Back Alive',
        donate: 'Donner Ã  Come Back Alive',
        share: 'Partager sur Bluesky',
        madeWith: 'Fait avec ðŸ’™ðŸ’› pour l\'Ukraine',
        apiNote: 'Utilise l\'API publique Bluesky â€¢ Sans authentification',
        errorNotFound: 'Profil introuvable. VÃ©rifiez le handle.',
        errorApi: 'Ã‰chec du chargement. Veuillez rÃ©essayer.',
        errorEmpty: 'Veuillez entrer un handle Bluesky.',
        errorInvalidHandle: 'Format invalide. Utilisez : handle.bsky.social',
        emptyState: 'Aucune activitÃ© pour cette pÃ©riode. Essayez une pÃ©riode plus longue !',
        shareText: 'ðŸ¦‹ Ma facture Bluesky : {amount} UAH !\n\nVÃ©rifiez la vÃ´tre & donnez Ã  Come Back Alive ðŸ‡ºðŸ‡¦\n\n'
      },
      es: {
        title: 'Factura de Bluesky',
        subtitle: 'Convierte tu actividad en apoyo para Ucrania',
        calculate: 'Calcular',
        today: 'Hoy',
        week: 'Semana',
        month: 'Mes',
        ratesTitle: 'Tarifas:',
        ratesDescription: 'Post: 5â‚´ | Repost: 3â‚´ | Respuesta: 2â‚´',
        itCheckbox: 'Â¿Trabajas en IT?',
        loading: 'Cargando tu actividad...',
        bill: 'ðŸ§¾ TU FACTURA',
        posts: 'Posts creados',
        reposts: 'Reposts hechos',
        replies: 'Respuestas escritas',
        total: 'TOTAL:',
        ctaTitle: 'Apoya a los defensores de Ucrania',
        ctaDescription: 'Dona el importe de tu factura a la fundaciÃ³n Come Back Alive',
        donate: 'Donar a Come Back Alive',
        share: 'Compartir en Bluesky',
        madeWith: 'Hecho con ðŸ’™ðŸ’› para Ucrania',
        apiNote: 'Usa la API pÃºblica de Bluesky â€¢ Sin autenticaciÃ³n',
        errorNotFound: 'Perfil no encontrado. Verifica el handle.',
        errorApi: 'Error al cargar datos. IntÃ©ntalo de nuevo.',
        errorEmpty: 'Por favor, introduce un handle de Bluesky.',
        errorInvalidHandle: 'Formato invÃ¡lido. Usa: handle.bsky.social',
        emptyState: 'Â¡Sin actividad en este perÃ­odo. Prueba un rango mÃ¡s largo!',
        shareText: 'ðŸ¦‹ Mi factura de Bluesky: {amount} UAH!\n\nÂ¡Revisa la tuya y dona a Come Back Alive! ðŸ‡ºðŸ‡¦\n\n'
      },
      pt: {
        title: 'Conta do Bluesky',
        subtitle: 'Transforme sua atividade em apoio Ã  UcrÃ¢nia',
        calculate: 'Calcular',
        today: 'Hoje',
        week: 'Semana',
        month: 'MÃªs',
        ratesTitle: 'Tarifas:',
        ratesDescription: 'Post: 5â‚´ | Repost: 3â‚´ | Resposta: 2â‚´',
        itCheckbox: 'VocÃª Ã© de TI?',
        loading: 'Carregando sua atividade...',
        bill: 'ðŸ§¾ SUA CONTA',
        posts: 'Posts criados',
        reposts: 'Reposts feitos',
        replies: 'Respostas escritas',
        total: 'TOTAL:',
        ctaTitle: 'Apoie os defensores da UcrÃ¢nia',
        ctaDescription: 'Doe o valor da sua conta para a fundaÃ§Ã£o Come Back Alive',
        donate: 'Doar para Come Back Alive',
        share: 'Compartilhar no Bluesky',
        madeWith: 'Feito com ðŸ’™ðŸ’› para a UcrÃ¢nia',
        apiNote: 'Usa a API pÃºblica do Bluesky â€¢ Sem autenticaÃ§Ã£o',
        errorNotFound: 'Perfil nÃ£o encontrado. Verifique o handle.',
        errorApi: 'Falha ao carregar dados. Tente novamente.',
        errorEmpty: 'Por favor, insira um handle do Bluesky.',
        errorInvalidHandle: 'Formato invÃ¡lido. Use: handle.bsky.social',
        emptyState: 'Nenhuma atividade neste perÃ­odo. Tente um intervalo maior!',
        shareText: 'ðŸ¦‹ Minha conta do Bluesky: {amount} UAH!\n\nConfira a sua e doe para Come Back Alive! ðŸ‡ºðŸ‡¦\n\n'
      },
      pl: {
        title: 'Rachunek za Bluesky',
        subtitle: 'ZamieÅ„ swojÄ… aktywnoÅ›Ä‡ we wsparcie dla Ukrainy',
        calculate: 'Oblicz',
        today: 'DziÅ›',
        week: 'TydzieÅ„',
        month: 'MiesiÄ…c',
        ratesTitle: 'Stawki:',
        ratesDescription: 'Post: 5â‚´ | Repost: 3â‚´ | OdpowiedÅº: 2â‚´',
        itCheckbox: 'Pracujesz w IT?',
        loading: 'Pobieranie aktywnoÅ›ci...',
        bill: 'ðŸ§¾ TWÃ“J RACHUNEK',
        posts: 'Posty utworzone',
        reposts: 'Reposty wykonane',
        replies: 'Odpowiedzi napisane',
        total: 'SUMA:',
        ctaTitle: 'Wesprzyj obroÅ„cÃ³w Ukrainy',
        ctaDescription: 'PrzekaÅ¼ kwotÄ™ rachunku na fundacjÄ™ Come Back Alive',
        donate: 'WpÅ‚aÄ‡ na Come Back Alive',
        share: 'UdostÄ™pnij na Bluesky',
        madeWith: 'Zrobione z ðŸ’™ðŸ’› dla Ukrainy',
        apiNote: 'UÅ¼ywa publicznego API Bluesky â€¢ Bez logowania',
        errorNotFound: 'Profil nie znaleziony. SprawdÅº handle.',
        errorApi: 'BÅ‚Ä…d Å‚adowania danych. SprÃ³buj ponownie.',
        errorEmpty: 'ProszÄ™ podaÄ‡ handle Bluesky.',
        errorInvalidHandle: 'NieprawidÅ‚owy format. UÅ¼yj: handle.bsky.social',
        emptyState: 'Brak aktywnoÅ›ci w tym okresie. SprÃ³buj dÅ‚uÅ¼szego zakresu!',
        shareText: 'ðŸ¦‹ MÃ³j rachunek za Bluesky: {amount} UAH!\n\nSprawdÅº swÃ³j i wpÅ‚aÄ‡ na Come Back Alive! ðŸ‡ºðŸ‡¦\n\n'
      }
    };

    let currentLang = 'en';

    function detectUserLanguage() {
      const languages = navigator.languages || [navigator.language || navigator.userLanguage || 'en'];
      for (const lang of languages) {
        const code = lang.toLowerCase();
        if (code.startsWith('uk') || code.startsWith('ua')) return 'uk';
        if (code.startsWith('ja')) return 'ja';
        if (code.startsWith('de')) return 'de';
        if (code.startsWith('fr')) return 'fr';
        if (code.startsWith('es')) return 'es';
        if (code.startsWith('pt')) return 'pt';
        if (code.startsWith('pl')) return 'pl';
      }
      return 'en';
    }

    function setLanguage(lang) {
      currentLang = lang;
      document.documentElement.lang = lang;
      document.querySelectorAll('[data-i18n]').forEach(el => {
        const key = el.dataset.i18n;
        if (i18n[lang][key]) {
          el.textContent = i18n[lang][key];
        }
      });
      document.querySelectorAll('.lang-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.lang === lang);
      });
    }

    function t(key) {
      return i18n[currentLang][key] || i18n.en[key] || key;
    }

    // ============================================
    // URL Parameter Helpers
    // ============================================
    function getUrlParams() {
      return new URLSearchParams(window.location.search);
    }

    function updateUrlParams(params) {
      const url = new URL(window.location);
      for (const [key, value] of Object.entries(params)) {
        if (value !== null && value !== undefined) {
          url.searchParams.set(key, value);
        } else {
          url.searchParams.delete(key);
        }
      }
      window.history.replaceState({}, '', url);
    }

    // ============================================
    // API Functions
    // ============================================
    const fetchOptions = {
      cache: 'no-store',
      headers: {
        'Cache-Control': 'no-cache'
      }
    };

    async function getProfile(handle) {
      const url = `${CONFIG.API_BASE}/app.bsky.actor.getProfile?actor=${encodeURIComponent(handle)}`;
      const res = await fetch(url, fetchOptions);
      if (!res.ok) throw new Error('notFound');
      return res.json();
    }

    async function getAuthorFeed(handle, limit = 100, cursor = null) {
      let url = `${CONFIG.API_BASE}/app.bsky.feed.getAuthorFeed?actor=${encodeURIComponent(handle)}&limit=${limit}`;
      if (cursor) url += `&cursor=${encodeURIComponent(cursor)}`;
      const res = await fetch(url, fetchOptions);
      if (!res.ok) throw new Error('apiFailed');
      return res.json();
    }

    function getFeedItemDate(item) {
      const isRepost = item.reason?.$type === 'app.bsky.feed.defs#reasonRepost';
      if (isRepost) {
        return new Date(item.reason.indexedAt);
      }
      return new Date(item.post.indexedAt || item.post.record.createdAt);
    }

    async function getAllPostsInRange(handle, startDate, endDate) {
      const posts = [];
      let cursor = null;
      let iterations = 0;
      const maxIterations = 10;

      while (iterations < maxIterations) {
        const data = await getAuthorFeed(handle, 100, cursor);
        iterations++;

        if (!data.feed || data.feed.length === 0) break;

        for (const item of data.feed) {
          const itemDate = getFeedItemDate(item);

          if (itemDate < startDate) {
            return posts;
          }

          if (itemDate <= endDate) {
            posts.push(item);
          }
        }

        if (!data.cursor) break;
        cursor = data.cursor;
      }

      return posts;
    }

    // ============================================
    // Calculation Logic
    // ============================================
    function calculateBill(profile, feedItems, multiplier = 1) {
      const breakdown = {
        posts: { count: 0, amount: 0, label: 'posts' },
        reposts: { count: 0, amount: 0, label: 'reposts' },
        replies: { count: 0, amount: 0, label: 'replies' }
      };

      for (const item of feedItems) {
        const post = item.post;
        const isRepost = item.reason?.$type === 'app.bsky.feed.defs#reasonRepost';
        const isReply = !!post.record?.reply;

        if (isRepost) {
          breakdown.reposts.count++;
        } else if (isReply) {
          breakdown.replies.count++;
        } else {
          breakdown.posts.count++;
        }
      }

      breakdown.posts.amount = breakdown.posts.count * CONFIG.RATES.post * multiplier;
      breakdown.reposts.amount = breakdown.reposts.count * CONFIG.RATES.repost * multiplier;
      breakdown.replies.amount = breakdown.replies.count * CONFIG.RATES.reply * multiplier;

      const total = Object.values(breakdown).reduce((sum, item) => sum + item.amount, 0);

      return { breakdown, total };
    }

    function getDateRange(period) {
      const now = new Date();
      const endDate = now;
      let startDate = null;

      switch (period) {
        case 'day':
          startDate = new Date(now);
          startDate.setHours(0, 0, 0, 0);
          break;
        case 'week':
          startDate = new Date(now);
          startDate.setDate(startDate.getDate() - 7);
          break;
        case 'month':
          startDate = new Date(now);
          startDate.setMonth(startDate.getMonth() - 1);
          break;
        default:
          startDate = new Date(now);
          startDate.setDate(startDate.getDate() - 7);
      }

      return { startDate, endDate };
    }

    function formatDate(date) {
      const localeMap = { en: 'en-US', uk: 'uk-UA', ja: 'ja-JP', de: 'de-DE', fr: 'fr-FR', es: 'es-ES', pt: 'pt-BR', pl: 'pl-PL' };
      const locale = localeMap[currentLang] || 'en-US';
      return date.toLocaleDateString(locale, { 
        month: 'short', 
        day: 'numeric', 
        year: 'numeric' 
      });
    }

    function formatPeriodDisplay(period, startDate, endDate) {
      if (period === 'day') {
        return formatDate(endDate);
      }
      return `${formatDate(startDate)} â€“ ${formatDate(endDate)}`;
    }

    // ============================================
    // UI Functions
    // ============================================
    function normalizeHandle(input) {
      let handle = input.trim().toLowerCase();
      handle = handle.replace(/^@/, '');
      if (!handle.includes('.')) {
        handle += '.bsky.social';
      }
      return handle;
    }

    function setActivePeriod(period) {
      document.querySelectorAll('.period-btn').forEach(b => {
        const isActive = b.dataset.period === period;
        b.classList.toggle('active', isActive);
        b.setAttribute('aria-pressed', String(isActive));
      });
    }

    function getActivePeriod() {
      return document.querySelector('.period-btn.active').dataset.period;
    }

    function showLoading() {
      document.getElementById('loading').classList.add('show');
      document.getElementById('results').classList.remove('show');
      document.getElementById('error-message').classList.remove('show');
    }

    function hideLoading() {
      document.getElementById('loading').classList.remove('show');
    }

    function showError(message) {
      const errorEl = document.getElementById('error-message');
      errorEl.textContent = message;
      errorEl.classList.add('show');
      hideLoading();
    }

    function showResults(profile, bill, period, dateRange) {
      hideLoading();

      const avatarEl = document.getElementById('avatar');
      if (profile.avatar) {
        avatarEl.src = profile.avatar;
        avatarEl.style.display = 'block';
      } else {
        avatarEl.style.display = 'none';
      }
      
      document.getElementById('display-name').textContent = profile.displayName || profile.handle;
      document.getElementById('handle-display').textContent = '@' + profile.handle;
      document.getElementById('period-display').textContent = formatPeriodDisplay(
        period, 
        dateRange.startDate, 
        dateRange.endDate
      );

      const breakdownEl = document.getElementById('breakdown');
      breakdownEl.innerHTML = '';

      const items = Object.values(bill.breakdown).filter(item => item.count > 0);
      
      if (items.length === 0) {
        const emptyMsg = document.createElement('div');
        emptyMsg.className = 'empty-state';
        emptyMsg.textContent = t('emptyState');
        breakdownEl.appendChild(emptyMsg);
      } else {
        for (const item of items) {
          const lineItem = document.createElement('div');
          lineItem.className = 'line-item';
          lineItem.innerHTML = `
            <span class="line-item-label">${t(item.label)} <span class="line-item-count">(${item.count.toLocaleString()})</span></span>
            <span class="line-item-amount">${item.amount.toFixed(2)} â‚´</span>
          `;
          breakdownEl.appendChild(lineItem);
        }
      }

      document.getElementById('total-amount').textContent = `${bill.total.toFixed(2)} â‚´`;

      const ctaSection = document.querySelector('.cta-section');
      ctaSection.style.display = bill.total > 0 ? 'block' : 'none';

      document.getElementById('results').classList.add('show');

      window.currentBill = { profile, bill, period };
    }

    function validateHandle(input) {
      if (!input || input.trim() === '') {
        return { valid: false, error: 'errorEmpty' };
      }
      
      const handle = normalizeHandle(input);
      
      if (!handle.includes('.') || handle.includes(' ')) {
        return { valid: false, error: 'errorInvalidHandle' };
      }
      
      if (!/^[a-zA-Z0-9.-]+$/.test(handle)) {
        return { valid: false, error: 'errorInvalidHandle' };
      }
      
      return { valid: true, handle };
    }

    // ============================================
    // Main Logic
    // ============================================
    async function calculate() {
      const handleInput = document.getElementById('handle-input').value;
      const calcBtn = document.getElementById('calculate-btn');
      
      const validation = validateHandle(handleInput);
      if (!validation.valid) {
        showError(t(validation.error));
        return;
      }
      
      const handle = validation.handle;
      const period = getActivePeriod();
      const dateRange = getDateRange(period);

      // Sync URL params
      updateUrlParams({ handle: handle, period: period });

      calcBtn.disabled = true;
      showLoading();

      try {
        const profile = await getProfile(handle);
        const posts = await getAllPostsInRange(handle, dateRange.startDate, dateRange.endDate);
        
        const isIT = document.getElementById('it-checkbox').checked;
        const multiplier = isIT ? 10 : 1;
        
        const bill = calculateBill(profile, posts, multiplier);
        showResults(profile, bill, period, dateRange);
      } catch (error) {
        if (error.message === 'notFound') {
          showError(t('errorNotFound'));
        } else {
          showError(t('errorApi'));
          console.error(error);
        }
      } finally {
        calcBtn.disabled = false;
      }
    }

    function share() {
      if (!window.currentBill) return;

      const { profile, bill, period } = window.currentBill;
      
      const shareableUrl = `${window.location.origin}${window.location.pathname}?handle=${encodeURIComponent(profile.handle)}&period=${encodeURIComponent(period)}&lang=${encodeURIComponent(currentLang)}`;
      
      const text = t('shareText')
        .replace('{amount}', bill.total.toFixed(2))
        + shareableUrl;

      const shareUrl = `https://bsky.app/intent/compose?text=${encodeURIComponent(text)}`;
      window.open(shareUrl, '_blank', 'noopener,noreferrer');
    }

    function donate() {
      window.open(CONFIG.DONATE_URL, '_blank', 'noopener,noreferrer');
    }

    // ============================================
    // Event Listeners
    // ============================================
    document.addEventListener('DOMContentLoaded', () => {
      // Language toggle
      document.querySelectorAll('.lang-btn').forEach(btn => {
        btn.addEventListener('click', () => setLanguage(btn.dataset.lang));
      });

      // Period selector
      document.querySelectorAll('.period-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          setActivePeriod(btn.dataset.period);
          
          const handleInput = document.getElementById('handle-input').value;
          if (handleInput.trim()) {
            calculate();
          }
        });
      });

      // Calculate button
      document.getElementById('calculate-btn').addEventListener('click', calculate);

      // Enter key in input
      document.getElementById('handle-input').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') calculate();
      });

      // Share button
      document.getElementById('share-btn').addEventListener('click', share);

      // Donate button
      document.getElementById('donate-btn').addEventListener('click', donate);

      // IT checkbox
      document.getElementById('it-checkbox').addEventListener('change', () => {
        const handleInput = document.getElementById('handle-input').value;
        if (handleInput.trim()) {
          calculate();
        }
      });

      // ---- Initialize from URL params and user preferences ----
      const urlParams = getUrlParams();

      // 1. Language: URL param > browser preference
      const langParam = urlParams.get('lang');
      if (langParam && i18n[langParam]) {
        setLanguage(langParam);
      } else {
        setLanguage(detectUserLanguage());
      }

      // 2. Period: URL param > default (week)
      const periodParam = urlParams.get('period');
      if (periodParam && CONFIG.VALID_PERIODS.includes(periodParam)) {
        setActivePeriod(periodParam);
      }

      // 3. Handle: auto-calculate if provided
      const handleParam = urlParams.get('handle');
      if (handleParam) {
        document.getElementById('handle-input').value = handleParam;
        calculate();
      }
    });
  </script>
</body>
</html>